{% extends "base.html" %}

{% block title %}Screenshot Renamer - File Management System{% endblock %}

{% block content %}
<div class="card">
    <h2>üñºÔ∏è Screenshot Renamer</h2>
    <p>Use OCR to extract text from screenshots and generate descriptive filenames.</p>
</div>

<div class="card" style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 20px;">
    <h3>üì± Quick Upload Method (Mobile & Desktop)</h3>
    <p style="font-size: 15px; margin-bottom: 10px;">
        <strong>Upload images ‚Üí Get renamed files ‚Üí Download to your device</strong>
    </p>
    <form id="uploadForm" enctype="multipart/form-data">
        <div class="form-group">
            <input type="file" id="fileUpload" name="files[]" multiple accept="image/*" 
                   style="padding: 15px; border: 2px dashed #2196f3; border-radius: 8px; width: 100%; cursor: pointer; background: #f8f9fa;">
            <div id="fileCount" style="margin-top: 10px; font-weight: bold; color: #27ae60;"></div>
        </div>
        <button type="button" class="btn" onclick="uploadAndPreview()" style="font-size: 16px; padding: 12px 24px;">
            üîç Upload & Preview Names
        </button>
        <button type="button" class="btn btn-success" onclick="executeUploadRename()" id="executeUploadBtn" style="display: none; font-size: 16px; padding: 12px 24px;">
            ‚úÖ Rename Files
        </button>
        <button type="button" class="btn btn-secondary" onclick="downloadAllRenamed()" id="downloadAllBtn" style="display: none; font-size: 16px; padding: 12px 24px;">
            ‚¨áÔ∏è Download All
        </button>
    </form>
</div>

<div class="card" style="background: #e8f5e9; border-left: 4px solid #27ae60;">
    <h4>üíª Advanced: Use File Paths (Desktop Only - Renames in Place)</h4>
    <p style="margin-bottom: 10px;">For desktop users: Enter file paths to rename files in their original location:</p>
    <form id="pathForm">
        <div class="form-group">
            <label for="fileList" style="font-weight: bold;">Screenshot File Paths (one per line):</label>
            <textarea id="fileList" name="fileList" rows="6" placeholder="C:\Users\YourName\Pictures\Screenshot1.png&#10;C:\Users\YourName\Pictures\Screenshot2.png&#10;C:\Users\YourName\Downloads\image.jpg" style="font-family: monospace;"></textarea>
            <small style="display: block; margin-top: 8px; color: #666;">
                üí° Tip: Right-click files ‚Üí "Copy as path" in Windows Explorer
            </small>
        </div>
        <button type="button" class="btn" onclick="previewFromPaths()" style="font-size: 16px; padding: 12px 24px;">
            üîç Preview Names
        </button>
        <button type="button" class="btn btn-success" onclick="executePathRename()" id="executePathBtn" style="display: none; font-size: 16px; padding: 12px 24px;">
            ‚úÖ Rename Files in Original Location
        </button>
    </form>
</div>

<div id="statusMessage" class="status-message"></div>

<div class="spinner" id="spinner"></div>

<div class="card" id="previewCard" style="display: none;">
    <h3>Preview - Proposed Renames</h3>
    <p id="previewSummary"></p>
    <div style="max-height: 500px; overflow-y: auto;">
        <table id="previewTable">
            <thead>
                <tr>
                    <th>Original Name</th>
                    <th>Proposed Name</th>
                    <th>Extracted Text</th>
                </tr>
            </thead>
            <tbody id="previewBody">
            </tbody>
        </table>
    </div>
</div>

<div class="card" id="resultsCard" style="display: none;">
    <h3>Renaming Results</h3>
    <div id="resultsContent"></div>
</div>

{% endblock %}

{% block scripts %}
<script>
let uploadedFiles = [];
let previewResults = [];

// Show file count when files are selected
document.getElementById('fileUpload').addEventListener('change', function() {
    const fileCount = this.files.length;
    const countDiv = document.getElementById('fileCount');
    if (fileCount > 0) {
        countDiv.textContent = `‚úÖ ${fileCount} file(s) selected`;
    } else {
        countDiv.textContent = '';
    }
});

function showStatus(message, type) {
    const statusDiv = document.getElementById('statusMessage');
    statusDiv.textContent = message;
    statusDiv.className = 'status-message active ' + type;
    statusDiv.style.display = 'block';
}

function hideStatus() {
    const statusDiv = document.getElementById('statusMessage');
    statusDiv.style.display = 'none';
}

function showSpinner() {
    document.getElementById('spinner').classList.add('active');
}

function hideSpinner() {
    document.getElementById('spinner').classList.remove('active');
}

function getFileList() {
    const fileListText = document.getElementById('fileList').value;
    return fileListText.split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0);
}

async function uploadAndPreview() {
    hideStatus();
    
    // Safely hide elements if they exist
    const previewCard = document.getElementById('previewCard');
    const resultsCard = document.getElementById('resultsCard');
    const executeUploadBtn = document.getElementById('executeUploadBtn');
    const executePathBtn = document.getElementById('executePathBtn');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    
    if (previewCard) previewCard.style.display = 'none';
    if (resultsCard) resultsCard.style.display = 'none';
    if (executeUploadBtn) executeUploadBtn.style.display = 'none';
    if (executePathBtn) executePathBtn.style.display = 'none';
    if (downloadAllBtn) downloadAllBtn.style.display = 'none';
    
    const fileInput = document.getElementById('fileUpload');
    if (!fileInput) {
        showStatus('File input not found', 'error');
        return;
    }
    
    const files = fileInput.files;
    
    if (files.length === 0) {
        showStatus('Please select at least one image file', 'error');
        return;
    }
    
    showSpinner();
    showStatus('Uploading and processing screenshots with OCR... This may take a moment.', 'warning');
    
    try {
        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('files[]', files[i]);
        }
        
        const response = await fetch('/rename/upload', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            uploadedFiles = result.results.map(r => r.original_path);
            previewResults = result.results;
            displayPreview(result.results);
            
            const executeUploadBtn = document.getElementById('executeUploadBtn');
            if (executeUploadBtn) {
                executeUploadBtn.style.display = 'inline-block';
            }
            
            showStatus(`Processed ${result.uploaded_count} screenshots`, 'success');
        } else {
            showStatus('Error: ' + result.error, 'error');
        }
    } catch (error) {
        showStatus('Error: ' + error.message, 'error');
    } finally {
        hideSpinner();
    }
}

async function previewFromPaths() {
    hideStatus();
    
    // Safely hide elements if they exist
    const previewCard = document.getElementById('previewCard');
    const resultsCard = document.getElementById('resultsCard');
    const executePathBtn = document.getElementById('executePathBtn');
    const executeUploadBtn = document.getElementById('executeUploadBtn');
    
    if (previewCard) previewCard.style.display = 'none';
    if (resultsCard) resultsCard.style.display = 'none';
    if (executePathBtn) executePathBtn.style.display = 'none';
    if (executeUploadBtn) executeUploadBtn.style.display = 'none';
    
    uploadedFiles = []; // Clear uploaded files
    
    const files = getFileList();
    
    if (files.length === 0) {
        showStatus('Please enter at least one file path', 'error');
        return;
    }
    
    showSpinner();
    showStatus('Processing screenshots with OCR... This may take a moment.', 'warning');
    
    try {
        const response = await fetch('/rename/preview', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ files: files })
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayPreview(result.results);
            
            const executePathBtn = document.getElementById('executePathBtn');
            if (executePathBtn) {
                executePathBtn.style.display = 'inline-block';
            }
            
            showStatus(`Processed ${result.results.length} screenshots`, 'success');
        } else {
            showStatus('Error: ' + result.error, 'error');
        }
    } catch (error) {
        showStatus('Error: ' + error.message, 'error');
    } finally {
        hideSpinner();
    }
}

function displayPreview(results) {
    const previewCard = document.getElementById('previewCard');
    const previewBody = document.getElementById('previewBody');
    const previewSummary = document.getElementById('previewSummary');
    
    const successCount = results.filter(r => r.status === 'success').length;
    const errorCount = results.filter(r => r.status === 'error').length;
    
    previewSummary.textContent = `${successCount} files ready to rename${errorCount > 0 ? `, ${errorCount} errors` : ''}`;
    
    previewBody.innerHTML = '';
    results.forEach(item => {
        const row = document.createElement('tr');
        
        if (item.status === 'error') {
            row.innerHTML = `
                <td>${item.original_name}</td>
                <td colspan="2" style="color: #e74c3c;">${item.error || 'Error processing file'}</td>
            `;
        } else {
            row.innerHTML = `
                <td>${item.original_name}</td>
                <td><strong>${item.proposed_name}</strong></td>
                <td style="font-size: 0.9em; color: #666;">${item.extracted_text.substring(0, 100)}${item.extracted_text.length > 100 ? '...' : ''}</td>
            `;
        }
        
        previewBody.appendChild(row);
    });
    
    previewCard.style.display = 'block';
}

// Execute rename for uploaded files
async function executeUploadRename() {
    if (!confirm('Rename these files?')) {
        return;
    }
    
    hideStatus();
    
    // Get all elements at the start
    const resultsCard = document.getElementById('resultsCard');
    const executeUploadBtn = document.getElementById('executeUploadBtn');
    const previewCard = document.getElementById('previewCard');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    
    // Hide/disable elements
    if (resultsCard) resultsCard.style.display = 'none';
    if (executeUploadBtn) executeUploadBtn.disabled = true;
    if (downloadAllBtn) downloadAllBtn.style.display = 'none';
    
    showSpinner();
    showStatus('Renaming files...', 'warning');
    
    try {
        const response = await fetch('/rename/execute-upload', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ files: uploadedFiles })
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayResults(result);
            showStatus('Files renamed successfully! Click "Download All" to get your files.', 'success');
            
            if (previewCard) previewCard.style.display = 'none';
            if (executeUploadBtn) executeUploadBtn.style.display = 'none';
            
            // Show download button
            if (downloadAllBtn) {
                downloadAllBtn.style.display = 'inline-block';
            }
            
            // Store download files for later
            window.renamedFiles = result.download_files || [];
        } else {
            showStatus('Error: ' + (result.error || 'Renaming failed'), 'error');
        }
    } catch (error) {
        showStatus('Error: ' + error.message, 'error');
    } finally {
        hideSpinner();
        if (executeUploadBtn) executeUploadBtn.disabled = false;
    }
}

// Execute rename for file paths (renames in original location)
async function executePathRename() {
    if (!confirm('Are you sure you want to rename these files in their original location? This action cannot be undone.')) {
        return;
    }
    
    hideStatus();
    
    const resultsCard = document.getElementById('resultsCard');
    const executePathBtn = document.getElementById('executePathBtn');
    const previewCard = document.getElementById('previewCard');
    
    if (resultsCard) resultsCard.style.display = 'none';
    if (executePathBtn) executePathBtn.disabled = true;
    
    const files = getFileList();
    
    showSpinner();
    showStatus('Renaming files in original location...', 'warning');
    
    try {
        const response = await fetch('/rename/execute', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ files: files })
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayResults(result);
            showStatus('Files renamed successfully in their original location!', 'success');
            if (previewCard) previewCard.style.display = 'none';
        } else {
            showStatus('Renaming completed with errors', 'warning');
            displayResults(result);
        }
    } catch (error) {
        showStatus('Error: ' + error.message, 'error');
    } finally {
        hideSpinner();
        document.getElementById('executeBtn').disabled = false;
    }
}

function displayResults(result) {
    const resultsCard = document.getElementById('resultsCard');
    const resultsContent = document.getElementById('resultsContent');
    
    const renamed = result.summary ? result.summary.renamed : 0;
    const errors = result.summary ? result.summary.errors : 0;
    
    let html = `
        <p><strong>Files Renamed:</strong> ${renamed}</p>
        <p><strong>Errors:</strong> ${errors}</p>
    `;
    
    if (result.results && result.results.length > 0) {
        html += '<h4>Details:</h4>';
        html += '<table><thead><tr><th>Original</th><th>New Name</th><th>Status</th></tr></thead><tbody>';
        
        result.results.forEach(item => {
            const statusClass = item.status === 'renamed' ? 'success' : 'error';
            const statusText = item.status === 'renamed' ? '‚úì Renamed' : '‚úó ' + (item.error || 'Error');
            
            html += `
                <tr>
                    <td>${item.original_name}</td>
                    <td>${item.proposed_name || '-'}</td>
                    <td style="color: ${item.status === 'renamed' ? '#27ae60' : '#e74c3c'};">${statusText}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
    }
    
    if (resultsContent) resultsContent.innerHTML = html;
    if (resultsCard) resultsCard.style.display = 'block';
}

function downloadAllRenamed() {
    const files = window.renamedFiles || [];
    
    if (files.length === 0) {
        showStatus('No files to download', 'error');
        return;
    }
    
    showStatus('Starting downloads...', 'warning');
    
    files.forEach((file, index) => {
        setTimeout(() => {
            const link = document.createElement('a');
            link.href = '/download/' + file.filename;
            link.download = file.filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }, index * 500); // Stagger downloads by 500ms
    });
    
    setTimeout(() => {
        showStatus(`Downloading ${files.length} file(s)! Check your downloads folder.`, 'success');
    }, 1000);
}
</script>
{% endblock %}
